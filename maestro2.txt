import sys
from pathlib import Path

from PySide6.QtWidgets import (
    QApplication, QMainWindow, QWidget,
    QVBoxLayout, QHBoxLayout, QGridLayout,
    QLabel, QFrame, QPushButton,
    QFileDialog,
    QTableWidget, QTableWidgetItem,
    QAbstractItemView, QSplitter, QStyledItemDelegate
)
from PySide6.QtCore import Qt, QTimer, QUrl
from PySide6.QtGui import QColor, QPainter, QPixmap

from PySide6.QtMultimedia import QMediaPlayer, QAudioOutput
from PySide6.QtMultimediaWidgets import QVideoWidget


APP_NAME = "TUI LIGHT â€“ Block Sequencer"

# ======================================================
# UTILS
# ======================================================

def fmt_time(ms):
    if ms <= 0:
        return "--:--"
    s = ms // 1000
    return f"{s//60:02d}:{s%60:02d}"

def media_icon(path):
    ext = Path(path).suffix.lower()
    if ext in [".mp3", ".wav"]:
        return "ðŸŽµ"
    if ext in [".mp4", ".mov"]:
        return "ðŸŽ¬"
    if ext in [".png", ".jpg", ".jpeg"]:
        return "ðŸ–¼"
    return "?"

# ======================================================
# PROJECTEUR
# ======================================================

class Projector:
    def __init__(self, group):
        self.group = group
        self.level = 0
        self.base_color = QColor("white")
        self.color = QColor("black")

# ======================================================
# AKAI APC MINI (INCHANGÃ‰)
# ======================================================

class ApcFader(QWidget):
    def __init__(self, index, callback):
        super().__init__()
        self.index = index
        self.callback = callback
        self.value = 0
        self.setFixedSize(26, 150)

    def paintEvent(self, _):
        p = QPainter(self)
        p.setPen(QColor("#555"))
        p.drawRect(11, 6, 4, 130)
        pos = 130 - int((self.value / 127) * 110)
        p.setBrush(QColor("#ddd"))
        p.drawRoundedRect(2, pos, 22, 10, 3, 3)

    def mousePressEvent(self, e): self.update_value(e.y())
    def mouseMoveEvent(self, e): self.update_value(e.y())

    def update_value(self, y):
        y = max(6, min(130, y))
        self.value = int((130 - y) / 110 * 127)
        self.callback(self.index, self.value)
        self.update()


class AkaiApcMini(QFrame):
    GROUPS = [
        "face", "contre", "lat", "douche",
        "face2", "contre2", "lat2", "douche2"
    ]

    COLORS = [
        QColor("white"), QColor("red"), QColor("orange"), QColor("yellow"),
        QColor("green"), QColor("cyan"), QColor("blue"), QColor("magenta")
    ]

    def __init__(self, projectors):
        super().__init__()
        self.projectors = projectors
        self.setObjectName("AkaiBox")
        self.setFixedWidth(300)

        root = QVBoxLayout(self)
        root.setAlignment(Qt.AlignTop)
        root.addWidget(QLabel("ðŸŽ¹ AKAI APC mini"))

        pads = QGridLayout()
        for r, color in enumerate(self.COLORS):
            for c, group in enumerate(self.GROUPS):
                btn = QPushButton("")
                btn.setFixedSize(26, 26)
                btn.setStyleSheet(f"background:{color.name()}; border-radius:4px;")
                btn.clicked.connect(lambda _, g=group, col=color: self.set_color(g, col))
                pads.addWidget(btn, r, c)
        root.addLayout(pads)

        faders = QHBoxLayout()
        for i in range(len(self.GROUPS)):
            faders.addWidget(ApcFader(i, self.set_level))
        root.addLayout(faders)

    def set_color(self, group, color):
        for p in self.projectors:
            if p.group == group:
                p.base_color = color
                if p.level > 0:
                    p.color = color

    def set_level(self, index, value):
        group = self.GROUPS[index]
        for p in self.projectors:
            if p.group == group:
                p.level = value
                p.color = p.base_color if value > 0 else QColor("black")

# ======================================================
# MEDIA PLAYER (INCHANGÃ‰)
# ======================================================

class MediaPlayer(QFrame):
    def __init__(self):
        super().__init__()
        layout = QVBoxLayout(self)

        self.video = QVideoWidget()
        self.image = QLabel(alignment=Qt.AlignCenter)

        self.audio = QAudioOutput()
        self.player = QMediaPlayer()
        self.player.setAudioOutput(self.audio)
        self.player.setVideoOutput(self.video)

        layout.addWidget(self.video)
        layout.addWidget(self.image)

    def play(self, path):
        ext = Path(path).suffix.lower()
        self.image.hide()
        self.video.show()

        if ext in [".png", ".jpg", ".jpeg"]:
            self.player.stop()
            pix = QPixmap(path).scaled(500, 300, Qt.KeepAspectRatio)
            self.image.setPixmap(pix)
            self.image.show()
            self.video.hide()
        else:
            self.player.setSource(QUrl.fromLocalFile(path))
            self.player.play()

# ======================================================
# SEQUENCEUR â€“ BARRE SUR TOUTE LA LIGNE (VRAI FIX)
# ======================================================

class ProgressDelegate(QStyledItemDelegate):
    def __init__(self, seq):
        super().__init__()
        self.seq = seq

    def paint(self, painter, option, index):
        # Dessin UNE SEULE FOIS sur la premiÃ¨re colonne
        if (
            index.row() == self.seq.current_row
            and index.column() == 0
            and self.seq.duration > 0
        ):
            table = self.seq.table
            rect = table.visualRect(index)
            full_width = table.viewport().width()

            progress = int(full_width * self.seq.position / self.seq.duration)

            painter.save()
            painter.setPen(Qt.NoPen)
            painter.setBrush(QColor("#2aa1ff"))
            painter.drawRect(0, rect.y(), progress, rect.height())
            painter.restore()

        super().paint(painter, option, index)

class Sequencer(QFrame):
    def __init__(self, player):
        super().__init__()
        self.player = player
        self.current_row = None
        self.duration = 0
        self.position = 0

        layout = QVBoxLayout(self)

        header = QHBoxLayout()
        header.addWidget(QLabel("ðŸ§± SÃ©quenceur"))
        header.addStretch()
        add = QPushButton("+")
        add.clicked.connect(self.add_files)
        header.addWidget(add)
        layout.addLayout(header)

        self.table = QTableWidget(0, 3)
        self.table.setHorizontalHeaderLabels(["", "Titre", "Temps"])
        self.table.verticalHeader().setVisible(False)
        self.table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        self.table.setShowGrid(False)
        self.table.setItemDelegate(ProgressDelegate(self))

        # âš ï¸ IMPORTANT : aucune sÃ©lection Qt
        self.table.setStyleSheet("""
            QTableWidget::item:selected {
                background: transparent;
            }
        """)

        self.table.cellDoubleClicked.connect(self.play_row)

        self.table.setColumnWidth(0, 40)
        self.table.setColumnWidth(1, 360)
        self.table.setColumnWidth(2, 140)

        layout.addWidget(self.table)

        player.player.positionChanged.connect(self.on_pos)
        player.player.durationChanged.connect(self.on_dur)

    def add_files(self):
        files, _ = QFileDialog.getOpenFileNames(
            self, "Ajouter mÃ©dias",
            "", "MÃ©dias (*.mp3 *.wav *.mp4 *.mov *.png *.jpg)"
        )
        for f in files:
            r = self.table.rowCount()
            self.table.insertRow(r)
            self.table.setItem(r, 0, QTableWidgetItem(media_icon(f)))
            it = QTableWidgetItem(Path(f).name)
            it.setData(Qt.UserRole, f)
            self.table.setItem(r, 1, it)
            self.table.setItem(r, 2, QTableWidgetItem("--:-- / --:--"))

    def play_row(self, row, _):
        self.current_row = row
        path = self.table.item(row, 1).data(Qt.UserRole)
        self.player.play(path)

    def on_dur(self, d):
        self.duration = d

    def on_pos(self, p):
        self.position = p
        if self.current_row is not None:
            self.table.item(self.current_row, 2).setText(
                f"{fmt_time(p)} / {fmt_time(self.duration)}"
            )
            self.table.viewport().update()

# ======================================================
# PLAN DE FEU (INCHANGÃ‰)
# ======================================================

class PlanDeFeu(QFrame):
    GROUPS = AkaiApcMini.GROUPS

    def __init__(self, projectors):
        super().__init__()
        layout = QVBoxLayout(self)
        layout.setAlignment(Qt.AlignTop)
        layout.addWidget(QLabel("ðŸ’¡ Plan de feu"))

        self.projectors = projectors
        self.lamps = {}

        for g in self.GROUPS:
            layout.addWidget(QLabel(g))
            row = QHBoxLayout()
            self.lamps[g] = []
            for _ in range(4):
                l = QLabel()
                l.setFixedSize(16, 16)
                l.setStyleSheet("background:#111; border-radius:8px;")
                row.addWidget(l)
                self.lamps[g].append(l)
            layout.addLayout(row)

        self.timer = QTimer()
        self.timer.timeout.connect(self.refresh)
        self.timer.start(60)

    def refresh(self):
        for g, lamps in self.lamps.items():
            projs = [p for p in self.projectors if p.group == g]
            for lamp, p in zip(lamps, projs):
                lamp.setStyleSheet(
                    f"background:{p.color.name()}; border-radius:8px;"
                    if p.level > 0 else "background:#111; border-radius:8px;"
                )

# ======================================================
# MAIN WINDOW
# ======================================================

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle(APP_NAME)
        self.resize(1500, 850)

        projectors = []
        for g in AkaiApcMini.GROUPS:
            projectors += [Projector(g) for _ in range(4)]

        akai = AkaiApcMini(projectors)
        player = MediaPlayer()
        seq = Sequencer(player)
        plan = PlanDeFeu(projectors)

        right = QWidget()
        r = QVBoxLayout(right)
        r.addWidget(plan)
        r.addWidget(player)

        splitter = QSplitter(Qt.Horizontal)
        splitter.setHandleWidth(3)
        splitter.addWidget(akai)
        splitter.addWidget(seq)
        splitter.addWidget(right)

        self.setCentralWidget(splitter)

        self.setStyleSheet("""
        QMainWindow { background:#0b0b0b; }
        QWidget { color:#ddd; }
        QFrame { background:#1a1a1a; border-radius:12px; }
        QPushButton { background:#2a2a2a; border-radius:6px; padding:6px; }
        QPushButton:hover { background:#3a3a3a; }
        #AkaiBox {
            background:#1e1e1e;
            border-left:3px solid #b30000;
            border-right:3px solid #b30000;
        }
        """)

# ======================================================
# RUN
# ======================================================

if __name__ == "__main__":
    app = QApplication(sys.argv)
    w = MainWindow()
    w.show()
    sys.exit(app.exec())
