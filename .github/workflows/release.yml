name: Build & Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # ─────────────────────────────────────────────
  # BUILD WINDOWS (exe + installer Inno Setup)
  # ─────────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build EXE
        run: pyinstaller --onefile --windowed --icon=mystrow.ico --add-data "logo.png;." --add-data "mystrow.ico;." main.py --name MyStrow

      - name: Generate SHA256 and .sig
        shell: pwsh
        run: |
          $hash = (Get-FileHash dist\MyStrow.exe -Algorithm SHA256).Hash.ToLower()
          "$hash  MyStrow.exe" | Out-File -Encoding ascii dist\sha256.txt
          Write-Host "SHA256: $hash"
          python _gen_sig.py dist/MyStrow.exe

      - name: Build Installer (Inno Setup)
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\maestro.iss
        shell: pwsh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            installer/installer_output/MyStrow_Setup.exe
            dist/MyStrow.exe
            dist/MyStrow.exe.sig
            dist/sha256.txt

  # ─────────────────────────────────────────────
  # BUILD MAC (.app + DMG)
  # ─────────────────────────────────────────────
  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller pillow

      - name: Build .app
        run: pyinstaller --windowed --icon=logo.png --add-data "logo.png:." main.py --name MyStrow

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "MyStrow" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "MyStrow.app" 150 190 \
            --app-drop-link 450 190 \
            "MyStrow_Installer.dmg" \
            "dist/MyStrow.app"

      - name: Upload Mac DMG
        uses: actions/upload-artifact@v4
        with:
          name: mac-dmg
          path: MyStrow_Installer.dmg

  # ─────────────────────────────────────────────
  # CREATE GITHUB RELEASE
  # ─────────────────────────────────────────────
  release:
    needs: [build-windows, build-mac]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "MyStrow ${{ github.ref_name }}"
          body: "Release ${{ github.ref_name }}\n\n**Downloads:**\n- Windows: `MyStrow_Setup.exe`\n- Mac: `MyStrow_Installer.dmg`"
          files: |
            windows-installer/MyStrow_Setup.exe
            windows-installer/MyStrow.exe
            windows-installer/sha256.txt
            mac-dmg/MyStrow_Installer.dmg

      - name: Supprimer les anciennes releases (garder 1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VER="${CURRENT_TAG#v}"
          gh release list --repo ${{ github.repository }} --limit 100 --json tagName --jq '.[].tagName' | \
          while read tag; do
            if [ "$tag" != "$CURRENT_TAG" ]; then
              TAG_VER="${tag#v}"
              # Ne supprimer que si le tag est plus ancien (sort -V place le plus vieux en premier)
              OLDEST=$(printf "%s\n%s" "$TAG_VER" "$CURRENT_VER" | sort -V | head -1)
              if [ "$OLDEST" = "$TAG_VER" ]; then
                echo "Suppression de la release $tag (plus ancienne que $CURRENT_TAG)..."
                gh release delete "$tag" --repo ${{ github.repository }} --yes --cleanup-tag
              else
                echo "Conservation de la release $tag (plus recente que $CURRENT_TAG, ignoree)"
              fi
            fi
          done
